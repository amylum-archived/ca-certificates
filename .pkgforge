name 'ca-certificates'
org 'amylum'

patch 'LICENSE.patch'
patch 'format-fix.patch'
patch 'remove-dupes.patch'
patch 'trust.patch'
patch 'binary.patch'

build do
  gopath = tmpdir(:gopath)
  user_path = "#{releasedir}/etc/ca-certificates"
  system_path = "#{releasedir}/usr/share/ca-certificates"

  run 'rm ca-bundle/*'
  run 'mkbundle -f ca-bundle.crt trusted_roots'
  run 'cd cmd/format && go get -d', 'GOPATH' => gopath
  run 'go run cmd/format/format.go -f ca-bundle.crt -d ca-bundle', 'GOPATH' => gopath

  run "mkdir -p #{releasedir}/usr/bin"
  run "mkdir -p #{releasedir}/etc/ssl/certs"
  run "mkdir -p #{user_path}/extracted #{user_path}/trust-source/{anchors,blacklist}"
  run "mkdir -p #{system_path}/trust-source/{anchors,blacklist}"

  run "cp update-ca-trust #{releasedir}/usr/bin/"
  run "cp ca-bundle/* #{system_path}/trust-source/anchors/"
  run "ln -s ../ca-certificates/extracted/tls-ca-bundle.pem #{releasedir}/etc/ssl/cert.pem"
end

test do
  # TODO: add tests
end
