name 'ca-certificates'
org 'amylum'

patch 'binary.patch'
patch 'trust.patch'

build do
  gopath = tmpdir(:gopath)
  user_path = "#{releasedir}/etc/ca-certificates"
  system_path = "#{releasedir}/usr/share/ca-certificates"
  bin_path = './cmd/cfssl-trust/cfssl-trust'

  run 'cd cmd/cfssl_trust && go get -d && go build .'

  def build_bundle(bundle_type)
    run "#{bin_path} release -b #{bundle_type} -d cert.db"
    release = `#{bin_path} releases -b #{bundle_type} -d cert.db`.lines.first.split.last
    run "#{bin_path} bundle -b #{bundle_type} -d cert.db > #{bundle_type}-bundle.crt"
  end

  build_bundle('ca')
  build_bundle('int')

  run "mkdir -p #{releasedir}/usr/bin"
  run "mkdir -p #{releasedir}/etc/ssl/certs"
  run "mkdir -p #{user_path}/extracted #{user_path}/trust-source/{anchors,blacklist}"
  run "mkdir -p #{system_path}/trust-source/{anchors,blacklist}"

  run "cp update-ca-trust #{releasedir}/usr/bin/"
  run "cp certdata/ca-bundle/* #{system_path}/trust-source/anchors/"
  run "ln -s ../ca-certificates/extracted/tls-ca-bundle.pem #{releasedir}/etc/ssl/cert.pem"
end

test do
  # TODO: add tests
end
